// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ===========================================
// Enums
// ===========================================

enum PlanType {
  FREE
  STARTER     // $9/mo tier
  PRO
  BUSINESS    // $79/mo tier
  ENTERPRISE  // Custom pricing
}

enum UserRole {
  SUPER_ADMIN   // Full platform control
  ADMIN         // Platform administrator
  DEVELOPER     // Marketplace developer
  SUPPORT       // Customer support (future)
  MEMBER        // Standard user (default)
}

enum OrgRole {
  ORG_OWNER     // Organization owner
  ORG_ADMIN     // Can manage org users/settings
  DEPT_MANAGER  // Manages their department
  ORG_MEMBER    // Regular org member
}

enum GatewayType {
  TELEGRAM_BOT    // Telegram Bot API (uses botToken)
  AI              // All AI providers (OpenAI, Anthropic, DeepSeek, Grok, Gemini, Mistral, Groq, Ollama)
  WEBHOOK         // Generic webhooks
  // TELEGRAM_ACCOUNT - MTProto user accounts (V2 - requires phone auth flow)
}

enum GatewayStatus {
  CONNECTED
  DISCONNECTED
  ERROR
}

// ===========================================
// User Model (Phase 1: Authentication)
// ===========================================
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String?
  emailVerified DateTime? @map("email_verified")
  image         String?

  // Role System (for admin, developer, support)
  role              UserRole  @default(MEMBER)
  
  // Organization Support (null = individual user)
  organizationId    String?   @map("organization_id")
  departmentId      String?   @map("department_id")
  orgRole           OrgRole?  @map("org_role")
  
  // Security (for future 2FA, account lockout)
  failedLoginCount  Int       @default(0) @map("failed_login_count")
  lockedUntil       DateTime? @map("locked_until")
  lastPasswordChange DateTime? @map("last_password_change")
  
  // Soft Delete Support
  deletedAt         DateTime? @map("deleted_at")

  // Subscription
  plan             PlanType @default(FREE)
  stripeCustomerId String?  @unique @map("stripe_customer_id")

  // Status
  isActive    Boolean   @default(true) @map("is_active")
  lastLoginAt DateTime? @map("last_login_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  sessions            Session[]
  passwordResetTokens PasswordResetToken[]
  gateways            Gateway[]
  creditBalance       CreditBalance?
  userPlugins         UserPlugin[]
  workflows           Workflow[]

  @@index([email])
  @@index([stripeCustomerId])
  @@index([organizationId])
  @@index([deletedAt])
  @@index([role])
  @@map("users")
}

// ===========================================
// Session Model (Phase 1: Authentication)
// ===========================================
model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  userAgent String?  @map("user_agent")
  ipAddress String?  @map("ip_address")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

// ===========================================
// Password Reset Token (Phase 1: Authentication)
// ===========================================
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

// ===========================================
// Gateway Model (Phase 2: Gateway System)
// ===========================================
model Gateway {
  id     String @id @default(cuid())
  userId String @map("user_id")
  
  // Organization Support (if owned by org, not individual user)
  organizationId String? @map("organization_id")

  name   String
  type   GatewayType
  status GatewayStatus @default(DISCONNECTED)

  // Encrypted credentials (AES-256-GCM)
  credentialsEnc String @map("credentials_enc") @db.Text
  
  // Provider-specific configuration
  config Json @default("{}")

  // Connection tracking
  lastConnectedAt DateTime? @map("last_connected_at")
  lastErrorAt     DateTime? @map("last_error_at")
  lastError       String?   @map("last_error")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  // organization Organization? @relation(...) // Add when Organization model exists
  workflows     Workflow[]
  workflowSteps WorkflowStep[]

  @@index([userId])
  @@index([organizationId])
  @@index([type])
  @@index([status])
  @@map("gateways")
}

// ===========================================
// Audit Log Model (Phase 1.5: Architecture)
// ===========================================
model AuditLog {
  id             String   @id @default(cuid())
  userId         String?  @map("user_id")
  organizationId String?  @map("organization_id")
  
  // Action details
  action         String   // 'gateway.create', 'plugin.install', 'user.login'
  resource       String   // 'gateway', 'plugin', 'user'
  resourceId     String?  @map("resource_id")
  
  // Additional context (no secrets!)
  metadata       Json?
  
  // Request info
  ipAddress      String?  @map("ip_address")
  userAgent      String?  @map("user_agent")
  
  // Result
  status         String   @default("success") // 'success', 'failure'
  
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([organizationId])
  @@index([action])
  @@index([resource, resourceId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ===========================================
// Credit System Models (Phase 1.5: Architecture)
// ===========================================
model CreditBalance {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  
  balance   Int      @default(0)  // Current credit balance
  lifetime  Int      @default(0)  // Total credits ever purchased
  
  // Auto-topup settings (JSON for flexibility)
  settings  Json     @default("{}")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions CreditTransaction[]

  @@map("credit_balances")
}

model CreditTransaction {
  id              String   @id @default(cuid())
  creditBalanceId String   @map("credit_balance_id")
  
  type            String   // 'purchase', 'usage', 'refund', 'bonus', 'grant'
  amount          Int      // Positive = credit, Negative = debit
  balanceAfter    Int      @map("balance_after")
  
  description     String
  metadata        Json?    // { stripeId?, aiProvider?, model?, itemId? }
  
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  creditBalance   CreditBalance @relation(fields: [creditBalanceId], references: [id], onDelete: Cascade)

  @@index([creditBalanceId])
  @@index([type])
  @@index([createdAt])
  @@map("credit_transactions")
}

// ===========================================
// Plugin Models (Phase 3: Plugin System)
// ===========================================

// Plugin definitions (system-defined for V1)
model Plugin {
  id            String        @id @default(cuid())
  slug          String        @unique  // "analytics", "welcome", "auto-reply"
  name          String
  description   String        @db.Text
  version       String        @default("1.0.0")
  
  // Requirements - which gateway types this plugin needs
  requiredGateways GatewayType[]
  
  // Configuration schema (JSON Schema format for validation)
  configSchema  Json          @default("{}")
  
  // Metadata for UI
  icon          String?       // Icon name or URL
  category      String        @default("general")  // "general", "analytics", "messaging", "automation"
  tags          String[]      @default([])         // Discovery tags: "sport", "blog", "ecommerce"
  isBuiltin     Boolean       @default(true)       // Built-in vs marketplace (V2)
  
  // Input/Output schemas for workflow integration (Phase 5+)
  inputSchema   Json?         @map("input_schema")   // What plugin accepts
  outputSchema  Json?         @map("output_schema")  // What plugin outputs
  
  // Status
  isActive      Boolean       @default(true)  @map("is_active")
  
  // Timestamps
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  
  // Relations
  userPlugins   UserPlugin[]
  workflowSteps WorkflowStep[]
  
  @@index([slug])
  @@index([isActive])
  @@index([category])
  @@map("plugins")
}

// User/Organization installed plugins
model UserPlugin {
  id            String        @id @default(cuid())
  userId        String        @map("user_id")
  pluginId      String        @map("plugin_id")
  
  // Organization Support (same pattern as Gateway)
  organizationId String?      @map("organization_id")
  
  // User's configuration for this plugin (validated against Plugin.configSchema)
  config        Json          @default("{}")
  
  // Gateway binding - which gateway this plugin uses (if any)
  gatewayId     String?       @map("gateway_id")
  
  // Status
  isEnabled     Boolean       @default(true) @map("is_enabled")
  
  // Execution stats
  executionCount Int          @default(0) @map("execution_count")
  lastExecutedAt DateTime?    @map("last_executed_at")
  lastError      String?      @map("last_error")
  
  // Timestamps
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  
  // Relations
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  plugin        Plugin        @relation(fields: [pluginId], references: [id])
  // organization Organization? @relation(...) // Add when Organization model exists
  
  // Unique per user+plugin OR per organization+plugin
  @@unique([userId, pluginId, organizationId])
  @@index([userId])
  @@index([pluginId])
  @@index([organizationId])
  @@index([isEnabled])
  @@map("user_plugins")
}

// ===========================================
// WORKFLOW MODELS (V2 Foundation - Phase 3)
// ===========================================

// Trigger types for workflows
enum WorkflowTriggerType {
  TELEGRAM_MESSAGE    // On new Telegram message
  TELEGRAM_CALLBACK   // On callback button press
  SCHEDULE            // Cron-based trigger
  WEBHOOK             // External HTTP trigger
  MANUAL              // User-triggered
}

// Workflow status
enum WorkflowStatus {
  DRAFT               // Being edited
  ACTIVE              // Running
  PAUSED              // Temporarily disabled
  ARCHIVED            // Soft deleted
}

// Workflow scope (determines visibility and access)
enum WorkflowScope {
  USER                // Personal workspace OR employee personal in org
  DEPARTMENT          // Shared within department (org only)
  ORGANIZATION        // Company-wide automation (org only)
}

// Workflow definition (user-created automation chain)
model Workflow {
  id              String              @id @default(cuid())
  userId          String              @map("user_id")
  organizationId  String?             @map("organization_id")
  departmentId    String?             @map("department_id")  // For DEPARTMENT scope
  
  // Scope determines visibility and access
  // - USER scope: If organizationId=NULL, personal workspace workflow
  //               If organizationId!=NULL, employee personal workflow in org
  // - DEPARTMENT: Requires departmentId, shared within department  
  // - ORGANIZATION: Shared across entire organization
  scope           WorkflowScope       @default(USER)
  
  // Basic info
  name            String
  description     String?
  slug            String              // User-friendly URL slug
  
  // Trigger configuration
  triggerType     WorkflowTriggerType
  triggerConfig   Json                @default("{}")  // Type-specific settings
  
  // Bound gateway (for telegram/ai triggers)
  gatewayId       String?             @map("gateway_id")
  
  // Status
  status          WorkflowStatus      @default(DRAFT)
  isEnabled       Boolean             @default(false) @map("is_enabled")
  
  // Execution stats
  executionCount  Int                 @default(0) @map("execution_count")
  lastExecutedAt  DateTime?           @map("last_executed_at")
  lastError       String?             @map("last_error")
  
  // Timestamps
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  
  // Relations
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  gateway         Gateway?            @relation(fields: [gatewayId], references: [id])
  // organization Organization?       @relation(...) // Add when Organization exists (Phase 4)
  // department    Department?         @relation(...) // Add when Department exists (Phase 4)
  steps           WorkflowStep[]
  runs            WorkflowRun[]
  
  @@unique([userId, organizationId, slug])
  @@index([userId])
  @@index([organizationId])
  @@index([departmentId])
  @@index([scope])
  @@index([status])
  @@index([isEnabled])
  @@map("workflows")
}

// Individual step in a workflow chain
model WorkflowStep {
  id              String    @id @default(cuid())
  workflowId      String    @map("workflow_id")
  
  // Step position
  order           Int       // Execution order (0, 1, 2...)
  name            String?   // Optional label
  
  // Plugin to execute
  pluginId        String    @map("plugin_id")
  
  // Step configuration
  // How to map trigger/previous step data to this plugin's input
  inputMapping    Json      @default("{}")  // { "text": "{{trigger.message.text}}" }
  
  // Static config for the plugin
  config          Json      @default("{}")
  
  // Gateway override (use specific gateway instead of workflow default)
  gatewayId       String?   @map("gateway_id")
  
  // Conditional execution (optional)
  condition       Json?     // { "if": "{{prev.sentiment}} == 'negative'" }
  
  // Error handling
  onError         String    @default("stop")  // "stop", "continue", "retry"
  maxRetries      Int       @default(0)       @map("max_retries")
  
  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // Relations
  workflow        Workflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  plugin          Plugin    @relation(fields: [pluginId], references: [id])
  gateway         Gateway?  @relation(fields: [gatewayId], references: [id])
  
  @@unique([workflowId, order])
  @@index([workflowId])
  @@index([pluginId])
  @@map("workflow_steps")
}

// Workflow execution history
model WorkflowRun {
  id              String    @id @default(cuid())
  workflowId      String    @map("workflow_id")
  
  // Trigger info
  triggeredBy     String    // "telegram_message", "schedule", "manual", etc.
  triggerData     Json?     @map("trigger_data")  // Original trigger payload
  
  // Execution status
  status          String    @default("running")  // running, completed, failed, cancelled
  
  // Results
  output          Json?     // Final output
  error           String?   // Error message if failed
  failedStepOrder Int?      @map("failed_step_order")  // Which step failed
  
  // Performance
  startedAt       DateTime  @default(now()) @map("started_at")
  completedAt     DateTime? @map("completed_at")
  durationMs      Int?      @map("duration_ms")
  
  // Relations
  workflow        Workflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  stepRuns        WorkflowStepRun[]
  
  @@index([workflowId])
  @@index([status])
  @@index([startedAt])
  @@map("workflow_runs")
}

// Individual step execution in a run
model WorkflowStepRun {
  id              String      @id @default(cuid())
  runId           String      @map("run_id")
  stepOrder       Int         @map("step_order")
  
  // Execution
  status          String      @default("pending")  // pending, running, completed, failed, skipped
  input           Json?       // Actual input after mapping
  output          Json?       // Plugin output
  error           String?
  
  // Performance
  startedAt       DateTime?   @map("started_at")
  completedAt     DateTime?   @map("completed_at")
  durationMs      Int?        @map("duration_ms")
  
  // Relations
  run             WorkflowRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  
  @@unique([runId, stepOrder])
  @@index([runId])
  @@map("workflow_step_runs")
}