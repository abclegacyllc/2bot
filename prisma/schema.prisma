// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ===========================================
// Enums
// ===========================================

enum PlanType {
  FREE
  STARTER     // $9/mo tier
  PRO
  BUSINESS    // $79/mo tier
  ENTERPRISE  // Custom pricing
}

enum UserRole {
  SUPER_ADMIN   // Full platform control
  ADMIN         // Platform administrator
  DEVELOPER     // Marketplace developer
  SUPPORT       // Customer support (future)
  MEMBER        // Standard user (default)
}

enum OrgRole {
  ORG_OWNER     // Organization owner
  ORG_ADMIN     // Can manage org users/settings
  DEPT_MANAGER  // Manages their department
  ORG_MEMBER    // Regular org member
}

enum MembershipStatus {
  INVITED       // Pending invite
  ACTIVE        // Full member
  SUSPENDED     // Temporarily disabled
}

enum DatabaseType {
  SHARED        // Uses default shared database (Free/Starter/Pro/Business)
  DEDICATED     // Has own database instance (Enterprise)
}

enum GatewayType {
  TELEGRAM_BOT    // Telegram Bot API (uses botToken)
  AI              // All AI providers (OpenAI, Anthropic, DeepSeek, Grok, Gemini, Mistral, Groq, Ollama)
  WEBHOOK         // Generic webhooks
  // TELEGRAM_ACCOUNT - MTProto user accounts (V2 - requires phone auth flow)
}

enum GatewayStatus {
  CONNECTED
  DISCONNECTED
  ERROR
}

// ===========================================
// User Model (Phase 1: Authentication)
// ===========================================
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String?
  emailVerified DateTime? @map("email_verified")
  image         String?

  // Role System (for admin, developer, support)
  role              UserRole  @default(MEMBER)
  
  // Security (for future 2FA, account lockout)
  failedLoginCount  Int       @default(0) @map("failed_login_count")
  lockedUntil       DateTime? @map("locked_until")
  lastPasswordChange DateTime? @map("last_password_change")
  
  // Soft Delete Support
  deletedAt         DateTime? @map("deleted_at")

  // Subscription (personal workspace)
  plan             PlanType @default(FREE)
  stripeCustomerId String?  @unique @map("stripe_customer_id")

  // Status
  isActive    Boolean   @default(true) @map("is_active")
  lastLoginAt DateTime? @map("last_login_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  sessions            Session[]
  passwordResetTokens PasswordResetToken[]
  gateways            Gateway[]
  creditBalance       CreditBalance?
  userPlugins         UserPlugin[]
  workflows           Workflow[]
  memberships         Membership[]
  invitedMemberships  Membership[] @relation("InvitedMemberships")
  departmentMembers   DepartmentMember[]
  resourceQuota       ResourceQuota?
  usageHistory        UsageHistory[]

  @@index([email])
  @@index([stripeCustomerId])
  @@index([deletedAt])
  @@index([role])
  @@map("users")
}

// ===========================================
// Session Model (Phase 1: Authentication)
// ===========================================
model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  userAgent String?  @map("user_agent")
  ipAddress String?  @map("ip_address")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

// ===========================================
// Password Reset Token (Phase 1: Authentication)
// ===========================================
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

// ===========================================
// Organization Model (Phase 4: Organization)
// ===========================================
model Organization {
  id               String       @id @default(cuid())
  name             String
  slug             String       @unique
  
  // Billing (linked in Phase 5)
  plan             PlanType     @default(FREE)
  stripeCustomerId String?      @unique @map("stripe_customer_id")
  
  // Limits (can override plan defaults)
  maxMembers       Int?         @map("max_members")
  
  // Database Isolation (Future-Ready)
  // See Phase 1.5 for architecture details
  databaseType     DatabaseType @default(SHARED)
  databaseUrl      String?      @map("database_url")     // Encrypted if dedicated
  databaseRegion   String?      @map("database_region")  // 'us-east', 'eu-west'
  
  // Status
  isActive         Boolean      @default(true) @map("is_active")
  
  // Timestamps
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")
  
  // Relations
  memberships      Membership[]
  departments      Department[]
  gateways         Gateway[]
  userPlugins      UserPlugin[]
  workflows        Workflow[]
  resourceQuota    ResourceQuota?
  usageHistory     UsageHistory[]
  alertConfig      AlertConfig?
  alertHistory     AlertHistory[]
  
  @@index([slug])
  @@index([databaseType])
  @@index([isActive])
  @@map("organizations")
}

// ===========================================
// Membership Model (Phase 4: Organization)
// User ↔ Organization relationship with role
// ===========================================
model Membership {
  id             String           @id @default(cuid())
  userId         String           @map("user_id")
  organizationId String           @map("organization_id")
  
  // Role in this organization
  role           OrgRole          @default(ORG_MEMBER)
  
  // Status
  status         MembershipStatus @default(INVITED)
  
  // Invite tracking
  invitedBy      String?          @map("invited_by")
  invitedAt      DateTime         @default(now()) @map("invited_at")
  joinedAt       DateTime?        @map("joined_at")
  
  // Timestamps
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  
  // Relations
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inviter        User?            @relation("InvitedMemberships", fields: [invitedBy], references: [id])
  departmentMembers DepartmentMember[]
  
  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@map("memberships")
}

// ===========================================
// Department Model (Phase 4: Organization)
// Organization hierarchy for resource quotas
// ===========================================
model Department {
  id               String       @id @default(cuid())
  organizationId   String       @map("organization_id")
  name             String
  description      String?
  
  // Resource Quotas (can override org defaults)
  maxWorkflows     Int?         @map("max_workflows")
  maxPlugins       Int?         @map("max_plugins")  
  maxApiCalls      Int?         @map("max_api_calls")    // Per day
  maxStorage       Int?         @map("max_storage")      // MB
  
  // Status
  isActive         Boolean      @default(true) @map("is_active")
  
  // Timestamps
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")
  
  // Relations
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members          DepartmentMember[]
  workflows        Workflow[]
  resourceQuota    ResourceQuota?
  usageHistory     UsageHistory[]
  
  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([isActive])
  @@map("departments")
}

// ===========================================
// Department Member (Phase 4: Organization)
// User ↔ Department relationship with role
// ===========================================
model DepartmentMember {
  id             String           @id @default(cuid())
  userId         String           @map("user_id")
  departmentId   String           @map("department_id")
  membershipId   String           @map("membership_id")
  
  // Role in this department
  role           DepartmentRole   @default(MEMBER)
  
  // Employee-level quotas (can override dept defaults)
  maxWorkflows   Int?             @map("max_workflows")     // Default: 5 for employees
  maxPlugins     Int?             @map("max_plugins")       // Default: 3 for employees
  
  // Timestamps
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  
  // Relations
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  department     Department       @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  membership     Membership       @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  
  @@unique([userId, departmentId])
  @@index([userId])
  @@index([departmentId])
  @@map("department_members")
}

enum DepartmentRole {
  MANAGER    // Can manage dept workflows, set employee limits
  MEMBER     // Can use dept workflows, create personal workflows
}

enum PeriodType {
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
}

// ===========================================
// Resource Quota (Phase 4: Organization Quotas)
// Tracks usage and limits for orgs, depts, users
// ===========================================
model ResourceQuota {
  id               String       @id @default(cuid())
  
  // Owner reference (exactly one of these)
  organizationId   String?      @unique @map("organization_id")
  departmentId     String?      @unique @map("department_id")
  userId           String?      @unique @map("user_id")
  
  // Limits (null = use parent/plan default)
  maxWorkflows     Int?         @map("max_workflows")
  maxPlugins       Int?         @map("max_plugins")
  maxApiCalls      Int?         @map("max_api_calls")      // Per day
  maxStorage       Int?         @map("max_storage")        // MB
  maxSteps         Int?         @map("max_steps")          // Per workflow
  
  // Current Usage (updated periodically)
  usedWorkflows    Int          @default(0) @map("used_workflows")
  usedPlugins      Int          @default(0) @map("used_plugins")
  usedApiCalls     Int          @default(0) @map("used_api_calls")
  usedStorage      Int          @default(0) @map("used_storage")
  
  // Reset tracking
  apiCallsResetAt  DateTime?    @map("api_calls_reset_at")
  
  // Timestamps
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")
  
  // Relations
  organization     Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department       Department?   @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  user             User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([organizationId])
  @@index([departmentId])
  @@index([userId])
  @@map("resource_quotas")
}

// ===========================================
// Usage History (Phase 4: Organization Quotas)
// Historical tracking for monitoring dashboard
// ===========================================
model UsageHistory {
  id               String       @id @default(cuid())
  
  // Owner reference (one of these)
  organizationId   String?      @map("organization_id")
  departmentId     String?      @map("department_id")
  userId           String?      @map("user_id")
  
  // Time bucket
  periodStart      DateTime     @map("period_start")
  periodType       PeriodType   @default(DAILY) @map("period_type")
  
  // Metrics
  apiCalls         Int          @default(0) @map("api_calls")
  workflowRuns     Int          @default(0) @map("workflow_runs")
  pluginExecutions Int          @default(0) @map("plugin_executions")
  storageUsed      Int          @default(0) @map("storage_used")    // MB at period end
  errors           Int          @default(0)
  
  // Cost tracking (for enterprise)
  estimatedCost    Decimal?     @map("estimated_cost") @db.Decimal(10, 2)
  
  // Timestamps
  createdAt        DateTime     @default(now()) @map("created_at")
  
  // Relations
  organization     Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department       Department?   @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  user             User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([organizationId, periodStart, periodType])
  @@unique([departmentId, periodStart, periodType])
  @@unique([userId, periodStart, periodType])
  @@index([periodStart])
  @@index([organizationId])
  @@index([departmentId])
  @@index([userId])
  @@map("usage_history")
}

// ===========================================
// Alert Config (Phase 4: Resource Monitoring)
// Configuration for resource alerts per organization
// ===========================================
model AlertConfig {
  id                      String   @id @default(cuid())
  organizationId          String   @unique @map("organization_id")
  
  // Threshold settings
  quotaWarningThreshold   Int      @default(80) @map("quota_warning_threshold")
  quotaCriticalThreshold  Int      @default(95) @map("quota_critical_threshold")
  errorRateThreshold      Int      @default(10) @map("error_rate_threshold")
  consecutiveFailures     Int      @default(3) @map("consecutive_failures")
  
  // Cost thresholds (enterprise)
  dailyCostThreshold      Int?     @map("daily_cost_threshold")
  monthlyCostThreshold    Int?     @map("monthly_cost_threshold")
  
  // Notification channels (JSON)
  channels                Json     @default("{\"email\": true}")
  
  // Status
  enabled                 Boolean  @default(true)
  
  // Timestamps
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  // Relations
  organization            Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@map("alert_configs")
}

// ===========================================
// Alert History (Phase 4: Resource Monitoring)
// Historical log of alerts sent
// ===========================================
model AlertHistory {
  id               String    @id @default(cuid())
  organizationId   String    @map("organization_id")
  
  // Alert details
  type             String    // AlertType enum value
  severity         String    // AlertSeverity enum value
  title            String
  message          String    @db.Text
  
  // Resource details (optional)
  resource         String?
  currentValue     Int?      @map("current_value")
  limitValue       Int?      @map("limit_value")
  percentage       Int?
  
  // Metadata (JSON)
  metadata         String?   @db.Text
  
  // Acknowledgement
  acknowledged     Boolean   @default(false)
  acknowledgedBy   String?   @map("acknowledged_by")
  acknowledgedAt   DateTime? @map("acknowledged_at")
  
  // Resolution
  resolvedAt       DateTime? @map("resolved_at")
  
  // Timestamps
  createdAt        DateTime  @default(now()) @map("created_at")
  
  // Relations
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([organizationId])
  @@index([type])
  @@index([severity])
  @@index([acknowledged])
  @@index([createdAt])
  @@map("alert_history")
}

// ===========================================
// Gateway Model (Phase 2: Gateway System)
// ===========================================
model Gateway {
  id     String @id @default(cuid())
  userId String @map("user_id")
  
  // Organization Support (if owned by org, not individual user)
  organizationId String? @map("organization_id")

  name   String
  type   GatewayType
  status GatewayStatus @default(DISCONNECTED)

  // Encrypted credentials (AES-256-GCM)
  credentialsEnc String @map("credentials_enc") @db.Text
  
  // Provider-specific configuration
  config Json @default("{}")

  // Connection tracking
  lastConnectedAt DateTime? @map("last_connected_at")
  lastErrorAt     DateTime? @map("last_error_at")
  lastError       String?   @map("last_error")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  workflows     Workflow[]
  workflowSteps WorkflowStep[]

  @@index([userId])
  @@index([organizationId])
  @@index([type])
  @@index([status])
  @@map("gateways")
}

// ===========================================
// Audit Log Model (Phase 1.5: Architecture)
// ===========================================
model AuditLog {
  id             String   @id @default(cuid())
  userId         String?  @map("user_id")
  organizationId String?  @map("organization_id")
  
  // Action details
  action         String   // 'gateway.create', 'plugin.install', 'user.login'
  resource       String   // 'gateway', 'plugin', 'user'
  resourceId     String?  @map("resource_id")
  
  // Additional context (no secrets!)
  metadata       Json?
  
  // Request info
  ipAddress      String?  @map("ip_address")
  userAgent      String?  @map("user_agent")
  
  // Result
  status         String   @default("success") // 'success', 'failure'
  
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([organizationId])
  @@index([action])
  @@index([resource, resourceId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ===========================================
// Credit System Models (Phase 1.5: Architecture)
// ===========================================
model CreditBalance {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  
  balance   Int      @default(0)  // Current credit balance
  lifetime  Int      @default(0)  // Total credits ever purchased
  
  // Auto-topup settings (JSON for flexibility)
  settings  Json     @default("{}")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions CreditTransaction[]

  @@map("credit_balances")
}

model CreditTransaction {
  id              String   @id @default(cuid())
  creditBalanceId String   @map("credit_balance_id")
  
  type            String   // 'purchase', 'usage', 'refund', 'bonus', 'grant'
  amount          Int      // Positive = credit, Negative = debit
  balanceAfter    Int      @map("balance_after")
  
  description     String
  metadata        Json?    // { stripeId?, aiProvider?, model?, itemId? }
  
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  creditBalance   CreditBalance @relation(fields: [creditBalanceId], references: [id], onDelete: Cascade)

  @@index([creditBalanceId])
  @@index([type])
  @@index([createdAt])
  @@map("credit_transactions")
}

// ===========================================
// Plugin Models (Phase 3: Plugin System)
// ===========================================

// Plugin definitions (system-defined for V1)
model Plugin {
  id            String        @id @default(cuid())
  slug          String        @unique  // "analytics", "welcome", "auto-reply"
  name          String
  description   String        @db.Text
  version       String        @default("1.0.0")
  
  // Requirements - which gateway types this plugin needs
  requiredGateways GatewayType[]
  
  // Configuration schema (JSON Schema format for validation)
  configSchema  Json          @default("{}")
  
  // Metadata for UI
  icon          String?       // Icon name or URL
  category      String        @default("general")  // "general", "analytics", "messaging", "automation"
  tags          String[]      @default([])         // Discovery tags: "sport", "blog", "ecommerce"
  isBuiltin     Boolean       @default(true)       // Built-in vs marketplace (V2)
  
  // Input/Output schemas for workflow integration (Phase 5+)
  inputSchema   Json?         @map("input_schema")   // What plugin accepts
  outputSchema  Json?         @map("output_schema")  // What plugin outputs
  
  // Status
  isActive      Boolean       @default(true)  @map("is_active")
  
  // Timestamps
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  
  // Relations
  userPlugins   UserPlugin[]
  workflowSteps WorkflowStep[]
  
  @@index([slug])
  @@index([isActive])
  @@index([category])
  @@map("plugins")
}

// User/Organization installed plugins
model UserPlugin {
  id            String        @id @default(cuid())
  userId        String        @map("user_id")
  pluginId      String        @map("plugin_id")
  
  // Organization Support (same pattern as Gateway)
  organizationId String?      @map("organization_id")
  
  // User's configuration for this plugin (validated against Plugin.configSchema)
  config        Json          @default("{}")
  
  // Gateway binding - which gateway this plugin uses (if any)
  gatewayId     String?       @map("gateway_id")
  
  // Status
  isEnabled     Boolean       @default(true) @map("is_enabled")
  
  // Execution stats
  executionCount Int          @default(0) @map("execution_count")
  lastExecutedAt DateTime?    @map("last_executed_at")
  lastError      String?      @map("last_error")
  
  // Timestamps
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  
  // Relations
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  plugin        Plugin        @relation(fields: [pluginId], references: [id])
  organization  Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Unique per user+plugin OR per organization+plugin
  @@unique([userId, pluginId, organizationId])
  @@index([userId])
  @@index([pluginId])
  @@index([organizationId])
  @@index([isEnabled])
  @@map("user_plugins")
}

// ===========================================
// WORKFLOW MODELS (V2 Foundation - Phase 3)
// ===========================================

// Trigger types for workflows
enum WorkflowTriggerType {
  TELEGRAM_MESSAGE    // On new Telegram message
  TELEGRAM_CALLBACK   // On callback button press
  SCHEDULE            // Cron-based trigger
  WEBHOOK             // External HTTP trigger
  MANUAL              // User-triggered
}

// Workflow status
enum WorkflowStatus {
  DRAFT               // Being edited
  ACTIVE              // Running
  PAUSED              // Temporarily disabled
  ARCHIVED            // Soft deleted
}

// Workflow scope (determines visibility and access)
enum WorkflowScope {
  USER                // Personal workspace OR employee personal in org
  DEPARTMENT          // Shared within department (org only)
  ORGANIZATION        // Company-wide automation (org only)
}

// Workflow definition (user-created automation chain)
model Workflow {
  id              String              @id @default(cuid())
  userId          String              @map("user_id")
  organizationId  String?             @map("organization_id")
  departmentId    String?             @map("department_id")  // For DEPARTMENT scope
  
  // Scope determines visibility and access
  // - USER scope: If organizationId=NULL, personal workspace workflow
  //               If organizationId!=NULL, employee personal workflow in org
  // - DEPARTMENT: Requires departmentId, shared within department  
  // - ORGANIZATION: Shared across entire organization
  scope           WorkflowScope       @default(USER)
  
  // Basic info
  name            String
  description     String?
  slug            String              // User-friendly URL slug
  
  // Trigger configuration
  triggerType     WorkflowTriggerType
  triggerConfig   Json                @default("{}")  // Type-specific settings
  
  // Bound gateway (for telegram/ai triggers)
  gatewayId       String?             @map("gateway_id")
  
  // Status
  status          WorkflowStatus      @default(DRAFT)
  isEnabled       Boolean             @default(false) @map("is_enabled")
  
  // Execution stats
  executionCount  Int                 @default(0) @map("execution_count")
  lastExecutedAt  DateTime?           @map("last_executed_at")
  lastError       String?             @map("last_error")
  
  // Timestamps
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  
  // Relations
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  gateway         Gateway?            @relation(fields: [gatewayId], references: [id])
  organization    Organization?       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department      Department?         @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  steps           WorkflowStep[]
  runs            WorkflowRun[]
  
  @@unique([userId, organizationId, slug])
  @@index([userId])
  @@index([organizationId])
  @@index([departmentId])
  @@index([scope])
  @@index([status])
  @@index([isEnabled])
  @@map("workflows")
}

// Individual step in a workflow chain
model WorkflowStep {
  id              String    @id @default(cuid())
  workflowId      String    @map("workflow_id")
  
  // Step position
  order           Int       // Execution order (0, 1, 2...)
  name            String?   // Optional label
  
  // Plugin to execute
  pluginId        String    @map("plugin_id")
  
  // Step configuration
  // How to map trigger/previous step data to this plugin's input
  inputMapping    Json      @default("{}")  // { "text": "{{trigger.message.text}}" }
  
  // Static config for the plugin
  config          Json      @default("{}")
  
  // Gateway override (use specific gateway instead of workflow default)
  gatewayId       String?   @map("gateway_id")
  
  // Conditional execution (optional)
  condition       Json?     // { "if": "{{prev.sentiment}} == 'negative'" }
  
  // Error handling
  onError         String    @default("stop")  // "stop", "continue", "retry"
  maxRetries      Int       @default(0)       @map("max_retries")
  
  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // Relations
  workflow        Workflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  plugin          Plugin    @relation(fields: [pluginId], references: [id])
  gateway         Gateway?  @relation(fields: [gatewayId], references: [id])
  
  @@unique([workflowId, order])
  @@index([workflowId])
  @@index([pluginId])
  @@map("workflow_steps")
}

// Workflow execution history
model WorkflowRun {
  id              String    @id @default(cuid())
  workflowId      String    @map("workflow_id")
  
  // Trigger info
  triggeredBy     String    // "telegram_message", "schedule", "manual", etc.
  triggerData     Json?     @map("trigger_data")  // Original trigger payload
  
  // Execution status
  status          String    @default("running")  // running, completed, failed, cancelled
  
  // Results
  output          Json?     // Final output
  error           String?   // Error message if failed
  failedStepOrder Int?      @map("failed_step_order")  // Which step failed
  
  // Performance
  startedAt       DateTime  @default(now()) @map("started_at")
  completedAt     DateTime? @map("completed_at")
  durationMs      Int?      @map("duration_ms")
  
  // Relations
  workflow        Workflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  stepRuns        WorkflowStepRun[]
  
  @@index([workflowId])
  @@index([status])
  @@index([startedAt])
  @@map("workflow_runs")
}

// Individual step execution in a run
model WorkflowStepRun {
  id              String      @id @default(cuid())
  runId           String      @map("run_id")
  stepOrder       Int         @map("step_order")
  
  // Execution
  status          String      @default("pending")  // pending, running, completed, failed, skipped
  input           Json?       // Actual input after mapping
  output          Json?       // Plugin output
  error           String?
  
  // Performance
  startedAt       DateTime?   @map("started_at")
  completedAt     DateTime?   @map("completed_at")
  durationMs      Int?        @map("duration_ms")
  
  // Relations
  run             WorkflowRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  
  @@unique([runId, stepOrder])
  @@index([runId])
  @@map("workflow_step_runs")
}