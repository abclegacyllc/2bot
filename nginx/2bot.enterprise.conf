# ===========================================
# 2Bot.org - Enterprise Nginx Configuration
# ===========================================
# Phase 6.7.5.4: Multi-subdomain reverse proxy
#
# Subdomains:
#   - 2bot.org         → Landing/Marketing (:3002)
#   - www.2bot.org     → Redirect to 2bot.org
#   - dash.2bot.org    → Dashboard (:3000)
#   - api.2bot.org     → API Server (:3001)
#   - admin.2bot.org   → Admin Panel (:3003)
#   - support.2bot.org → Support Team (:3004)
#   - docs.2bot.org    → Documentation (:3005)
#   - dev.2bot.org     → Developer Portal (:3006)
#
# Prerequisites:
#   - Cloudflare Origin Certificate at /etc/nginx/ssl/2bot.crt
#   - Cloudflare Origin Key at /etc/nginx/ssl/2bot.key
#   - DNS records pointing all subdomains to this server
#
# Installation:
#   sudo cp nginx/2bot.enterprise.conf /etc/nginx/sites-available/2bot
#   sudo ln -sf /etc/nginx/sites-available/2bot /etc/nginx/sites-enabled/
#   sudo nginx -t && sudo systemctl reload nginx
# ===========================================

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=2bot_api:10m rate=100r/s;
limit_req_zone $binary_remote_addr zone=2bot_auth:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=2bot_general:10m rate=200r/s;

# Upstream definitions
upstream 2bot_web {
    server 127.0.0.1:3002;
    keepalive 32;
}

upstream 2bot_dashboard {
    server 127.0.0.1:3000;
    keepalive 32;
}

upstream 2bot_api {
    server 127.0.0.1:3001;
    keepalive 32;
}

upstream 2bot_admin {
    server 127.0.0.1:3003;
    keepalive 32;
}

upstream 2bot_support {
    server 127.0.0.1:3004;
    keepalive 32;
}

upstream 2bot_docs {
    server 127.0.0.1:3005;
    keepalive 32;
}

upstream 2bot_dev {
    server 127.0.0.1:3006;
    keepalive 32;
}

# ===========================================
# HTTP to HTTPS redirect (all subdomains)
# ===========================================
server {
    listen 80;
    listen [::]:80;
    server_name 2bot.org www.2bot.org dash.2bot.org api.2bot.org admin.2bot.org support.2bot.org docs.2bot.org dev.2bot.org;

    # Health check (for load balancers)
    location = /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # Redirect all HTTP to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# ===========================================
# Main Site: 2bot.org
# ===========================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name 2bot.org;

    ssl_certificate /etc/nginx/ssl/2bot.crt;
    ssl_certificate_key /etc/nginx/ssl/2bot.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL_2BOT:10m;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    access_log /var/log/nginx/2bot.org.access.log;
    error_log /var/log/nginx/2bot.org.error.log warn;

    location / {
        proxy_pass http://2bot_web;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

# ===========================================
# www redirect → 2bot.org
# ===========================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.2bot.org;

    ssl_certificate /etc/nginx/ssl/2bot.crt;
    ssl_certificate_key /etc/nginx/ssl/2bot.key;

    return 301 https://2bot.org$request_uri;
}

# ===========================================
# Dashboard: dash.2bot.org
# ===========================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name dash.2bot.org;

    ssl_certificate /etc/nginx/ssl/2bot.crt;
    ssl_certificate_key /etc/nginx/ssl/2bot.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    access_log /var/log/nginx/dash.2bot.org.access.log;
    error_log /var/log/nginx/dash.2bot.org.error.log warn;

    limit_req zone=2bot_general burst=50 nodelay;

    # Next.js static files
    location /_next/static/ {
        proxy_pass http://2bot_dashboard;
        proxy_cache_valid 200 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # Next.js HMR WebSocket (development only)
    location /_next/webpack-hmr {
        proxy_pass http://2bot_dashboard;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }

    location / {
        proxy_pass http://2bot_dashboard;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

# ===========================================
# API: api.2bot.org
# ===========================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.2bot.org;

    ssl_certificate /etc/nginx/ssl/2bot.crt;
    ssl_certificate_key /etc/nginx/ssl/2bot.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    # Security headers
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;

    access_log /var/log/nginx/api.2bot.org.access.log;
    error_log /var/log/nginx/api.2bot.org.error.log warn;

    # Health check (no rate limit)
    location = /health {
        proxy_pass http://2bot_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # Stripe webhook (no rate limit, raw body)
    location = /webhooks/stripe {
        proxy_pass http://2bot_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_request_buffering off;
    }

    # Auth endpoints - stricter rate limiting
    location ~ ^/(auth|login|register|forgot-password) {
        limit_req zone=2bot_auth burst=10 nodelay;
        
        proxy_pass http://2bot_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # All other API routes
    location / {
        limit_req zone=2bot_api burst=50 nodelay;
        
        proxy_pass http://2bot_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        client_max_body_size 50M;
    }
}

# ===========================================
# Admin: admin.2bot.org
# ===========================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name admin.2bot.org;

    ssl_certificate /etc/nginx/ssl/2bot.crt;
    ssl_certificate_key /etc/nginx/ssl/2bot.key;
    ssl_protocols TLSv1.2 TLSv1.3;

    # Extra security for admin panel
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';" always;

    access_log /var/log/nginx/admin.2bot.org.access.log;
    error_log /var/log/nginx/admin.2bot.org.error.log warn;

    # IP allowlist for admin (uncomment and configure as needed)
    # allow 1.2.3.4;
    # allow 10.0.0.0/8;
    # deny all;

    location / {
        proxy_pass http://2bot_admin;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

# ===========================================
# Support Team: support.2bot.org (Phase 7)
# ===========================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name support.2bot.org;

    ssl_certificate /etc/nginx/ssl/2bot.crt;
    ssl_certificate_key /etc/nginx/ssl/2bot.key;

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    access_log /var/log/nginx/support.2bot.org.access.log;
    error_log /var/log/nginx/support.2bot.org.error.log warn;

    location / {
        proxy_pass http://2bot_support;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

# ===========================================
# Documentation: docs.2bot.org (Future)
# ===========================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name docs.2bot.org;

    ssl_certificate /etc/nginx/ssl/2bot.crt;
    ssl_certificate_key /etc/nginx/ssl/2bot.key;

    access_log /var/log/nginx/docs.2bot.org.access.log;
    error_log /var/log/nginx/docs.2bot.org.error.log warn;

    # Cache static documentation
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        proxy_pass http://2bot_docs;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    location / {
        proxy_pass http://2bot_docs;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# ===========================================
# Developer Portal: dev.2bot.org (Future)
# ===========================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name dev.2bot.org;

    ssl_certificate /etc/nginx/ssl/2bot.crt;
    ssl_certificate_key /etc/nginx/ssl/2bot.key;

    access_log /var/log/nginx/dev.2bot.org.access.log;
    error_log /var/log/nginx/dev.2bot.org.error.log warn;

    location / {
        proxy_pass http://2bot_dev;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
